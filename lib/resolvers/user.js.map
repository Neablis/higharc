{"version":3,"sources":["../../src/resolvers/user.ts"],"names":["UserResolver","User","Smoothie","String","user","ctx","email","findOne","relations","smoothies","signup","data","existingUser","where","firstName","lastName","password","isAdmin","errors","length","Error","save","login","loggedIn"],"mappings":";;;;;;;;;;;AAAA;;AAUA;;AACA;;AACA;;AAEA;;AACA;;;;IAGaA,Y,WADZ,2BAASC,aAAT,C,UAEE,8B,UACA,wBAAM,MAAMA,aAAZ,C;SAEE,uB;gLAMF,gCAAc,MAAM,CAACC,iBAAD,CAApB,C;SACgB,wB;gLAIhB,2BAAS,MAAMD,aAAf,C;SAEE,sBAAI,MAAJ,C;2LA0BF,wBAAM,MAAME,MAAZ,C;SAEE,sBAAI,MAAJ,C;yMA9CL,MACaH,YADb,CAC0B;AACxB,QAEMI,IAFN,CAGSC,GAHT,EAI6B;AAC3B,UAAM;AAAEC,MAAAA;AAAF,QAAYD,GAAlB;AACA,WAAOJ,cAAKM,OAAL,CAAa;AAAED,MAAAA;AAAF,KAAb,EAAwB;AAAEE,MAAAA,SAAS,EAAE,CAAC,WAAD,EAAc,uBAAd;AAAb,KAAxB,CAAP;AACD;;AAED,QACMC,SADN,CACwBL,IADxB,EACyD;AACvD,WAAOA,IAAI,CAACK,SAAL,IAAkB,EAAzB;AACD;;AAED,QACMC,MADN,CAEeC,IAFf,EAG6B;AAC3B,UAAMC,YAAY,GAAG,MAAMX,cAAKM,OAAL,CAAa;AACtCM,MAAAA,KAAK,EAAE;AACLP,QAAAA,KAAK,EAAEK,IAAI,CAACL;AADP;AAD+B,KAAb,CAA3B;AAMA,QAAIM,YAAJ,EAAkB,OAAOA,YAAP;AAElB,UAAMR,IAAI,GAAG,IAAIH,aAAJ,EAAb;AACAG,IAAAA,IAAI,CAACE,KAAL,GAAaK,IAAI,CAACL,KAAlB;AACAF,IAAAA,IAAI,CAACU,SAAL,GAAiBH,IAAI,CAACG,SAAtB;AACAV,IAAAA,IAAI,CAACW,QAAL,GAAgBJ,IAAI,CAACI,QAArB;AACAX,IAAAA,IAAI,CAACY,QAAL,GAAgBL,IAAI,CAACK,QAArB;AACAZ,IAAAA,IAAI,CAACa,OAAL,GAAeN,IAAI,CAACM,OAAL,IAAgB,KAA/B;AAEA,UAAMC,MAAM,GAAG,MAAM,8BAASd,IAAT,CAArB;;AAEA,QAAIc,MAAM,CAACC,MAAP,GAAgB,CAApB,EAAuB;AACrB,YAAM,IAAIC,KAAJ,CAAU,yBAAV,CAAN;AACD,KAFD,MAEO;AACL,aAAOhB,IAAI,CAACiB,IAAL,EAAP;AACD;AACF;;AAED,QACMC,KADN,CAEeX,IAFf,EAG0B;AACxB,UAAMC,YAAY,GAAG,MAAMX,cAAKM,OAAL,CAAa;AACtCM,MAAAA,KAAK,EAAE;AACLP,QAAAA,KAAK,EAAEK,IAAI,CAACL;AADP;AAD+B,KAAb,CAA3B;AAMA,QAAIiB,QAAQ,GAAG,MAAM,uBAAWZ,IAAI,CAACK,QAAhB,EAA0BJ,YAA1B,CAArB;;AAEA,QAAIW,QAAQ,IAAIX,YAAhB,EAA8B;AAC5B,aAAO,wBAAYA,YAAZ,CAAP;AACD,KAFD,MAEO;AACL,YAAM,IAAIQ,KAAJ,CAAU,iBAAV,CAAN;AACD;AACF;;AA5DuB,C","sourcesContent":["import {\n  Resolver,\n  Query,\n  Arg,\n  Mutation,\n  Ctx,\n  Authorized,\n  FieldResolver,\n  Root,\n} from 'type-graphql';\nimport { Context, LoginInput, SignupInput } from '../types';\nimport { createToken, isPassword } from '../utils'\nimport { validate } from \"class-validator\";\n\nimport User from '../entity/User';\nimport Smoothie from '../entity/Smoothie';\n\n@Resolver(User)\nexport class UserResolver {\n  @Authorized()\n  @Query(() => User)\n  async user(\n    @Ctx() ctx: Context\n  ): Promise<User | undefined> { \n    const { email } = ctx;\n    return User.findOne({ email }, { relations: ['smoothies', 'smoothies.ingredients']});\n  }\n\n  @FieldResolver(() => [Smoothie])\n  async smoothies(@Root() user: User): Promise<Smoothie[]> {\n    return user.smoothies || []\n  }\n\n  @Mutation(() => User)\n  async signup(\n    @Arg('data') data: SignupInput,\n  ): Promise<User | undefined> {\n    const existingUser = await User.findOne({ \n      where: {  \n        email: data.email\n      }\n    });\n\n    if (existingUser) return existingUser;\n\n    const user = new User();\n    user.email = data.email;\n    user.firstName = data.firstName;\n    user.lastName = data.lastName;\n    user.password = data.password;\n    user.isAdmin = data.isAdmin || false;\n\n    const errors = await validate(user);\n\n    if (errors.length > 0) {\n      throw new Error('Error creating new user'); \n    } else {\n      return user.save();\n    }\n  }\n\n  @Query(() => String)\n  async login(\n    @Arg('data') data: LoginInput,\n  ): Promise<string | void> {\n    const existingUser = await User.findOne({ \n      where: {  \n        email: data.email,\n      }\n    });\n\n    let loggedIn = await isPassword(data.password, existingUser)\n\n    if (loggedIn && existingUser) {\n      return createToken(existingUser)\n    } else {\n      throw new Error('Incorrect Login')\n    }\n  }\n}\n"],"file":"user.js"}